<div class="activity">
    <ng-container *ngIf="collapsible">
        <ng-container [ngTemplateOutlet]="collapsibleActivityTemplate" [ngTemplateOutletContext]="{activity: activity}"></ng-container>
    </ng-container>
    <ng-container *ngIf="!collapsible">
        <ng-container [ngTemplateOutlet]="activityTemplate" [ngTemplateOutletContext]="{activity: activity}"></ng-container>
    </ng-container>
</div>

<ng-template #activityTemplate>
    <ng-container *ngTemplateOutlet="headerTemplate"></ng-container>
    <ng-container *ngTemplateOutlet="contentTemplate"></ng-container>
</ng-template>

<ng-template #collapsibleActivityTemplate>
    <app-collapsible [customHeader]="true">
        <ng-container headerContent *ngTemplateOutlet="headerTemplate"></ng-container>
        <ng-container hiddenContent *ngTemplateOutlet="contentTemplate"></ng-container>
    </app-collapsible>
</ng-template>

<ng-template #headerTemplate>
    <div class="box p-2 d-flex justify-content-between align-items-center"
         [ngClass]="{'mb-2': activity.gameData?.cardSnapshots.length}"
    >
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <app-athlete *ngIf="activity?.athlete" [size]="'medium'"
                             [athleteId]="activity?.athlete.id"
                >
                    <div class="d-flex align-items-center mt-0-5">
                        <app-activity-type-icon [type]="activityType"
                                                [width]="14"
                                                [height]="14"
                        >
                        </app-activity-type-icon>
                        <span class="m-0 ml-1 text-small text-bold">{{activity[validationService.baseActivityTypeMap.get(activityType)] | activityProp : validationService.baseActivityTypeMap.get(activityType)}}</span>
                    </div>
                </app-athlete>
            </div>
        </div>
        <div class="d-flex justify-content-between flex-column align-items-end">
            <app-strava-link [activityId]="activity.id"></app-strava-link>
            <app-link *ngIf="activity.map?.summary_polyline;" [text]="'View Map'" (click)="showMap()"></app-link>
        </div>
    </div>
    <app-entity-id [id]="activity.id"></app-entity-id>
</ng-template>

<ng-template #mapViewPopup>
    <div class="popup box">
        <app-swiper [polyline]="activity.map?.summary_polyline"
                    [activityType]="activityType"
        ></app-swiper>
    </div>
</ng-template>

<ng-template #contentTemplate>
    <div *ngFor="let card of activity.gameData?.cardSnapshots; trackBy: cardTrackBy" class="box p-2 mb-2">
        <div class="d-flex align-items-center justify-content-between"
             [ngClass]="{'mb-2': card.attachedImages?.length || activity.map?.summary_polyline}"
        >
            <div class="d-flex align-items-center">
                <app-athlete *ngIf="activity?.athlete" [athleteId]="activity?.athlete.id"></app-athlete>
                &nbsp;
                <span class="text-medium">completed <span class="text-bold">"{{card.title}}"</span></span>
            </div>
            <app-image [src]="!!card.getImageSource ? card.getImageSource() : ''" [small]="true"></app-image>
        </div>
        <ng-container *ngIf="showReports">
            <p class="color-other" *ngFor="let report of card.reports">{{report.comment}} by {{report.createdBy}}</p>
        </ng-container>
        <app-gallery [images]="card.attachedImages"
                     [polyline]="activity.map?.summary_polyline"
                     [activityType]="activityType"
        ></app-gallery>
        <div class="mt-2" *ngIf="card.authorNote?.length !== 0">
            <app-comment [text]="card.authorNote"></app-comment>
        </div>
        <div class="d-flex justify-content-between mt-2">
            <div class="flex-shrink-1">
                <app-button (click)="report(card.id)"
                            [small]="true"
                            [label]="(card?.reportedByMe) ? 'Reported' : 'Report'"
                            [icon]="'flag'"
                            [type]="(card?.reportedByMe) ? ButtonType.DANGER_FILLED: ButtonType.DANGER"></app-button>
            </div>
            <div>
                <app-button (click)="openComments(card)"
                            [small]="true"
                            [label]="(card.comments.length || '').toString()"
                            [icon]="'comment'"
                            [type]="(card?.reportedByMe) ? ButtonType.DANGER_FILLED: ButtonType.DANGER"></app-button>
            </div>
            <div class="flex-shrink-1">
                <app-button (click)="card?.likedByMe || like(card)"
                            [small]="true"
                            [label]="(card?.likes?.length || 'Like').toString()"
                            [icon]="'fire'"
                            [type]="card?.likedByMe ? ButtonType.DANGER_FILLED: ButtonType.DANGER"></app-button>
            </div>
        </div>
    </div>
</ng-template>

<ng-template #commentsPopup>
    <div class="popup box">
        <div class="full-width p-3 d-flex flex-column align-items-center">
            <p class="mt-2 pt-2 mb-4 d-flex align-items-center">
                Comments for&nbsp;<span class="text-bold">"{{selectedCard.title}}"</span>
            </p>
            <div *ngIf="selectedCard.authorNote" class="mb-2 full-width">
                <app-comment [authorId]="activity.athlete.id.toString()" [text]="selectedCard?.authorNote"></app-comment>
            </div>
            <div *ngFor="let comment of selectedCard?.comments" class="mb-2 full-width">
                <app-comment [comment]="comment"></app-comment>
            </div>

            <div class="mt-3 full-width">
                <app-textarea [fc]="activityComment" [label]="'Leave your comment here'" [rows]="3"></app-textarea>
            </div>
            <div class="mt-4 mb-2 full-width">
                <app-button type="action"
                            [label]="'Submit'"
                            (buttonClick)="addComment()"
                ></app-button>
            </div>
            <div class="mb-3">
                <app-button (buttonClick)="closeComments()" [label]="'Cancel'"></app-button>
            </div>
        </div>
    </div>
</ng-template>
