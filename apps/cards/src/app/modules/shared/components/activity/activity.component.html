<div class="activity">
    <ng-container *ngIf="collapsible">
        <ng-container [ngTemplateOutlet]="collapsibleActivityTemplate" [ngTemplateOutletContext]="{activity: activity}"></ng-container>
    </ng-container>
    <ng-container *ngIf="!collapsible">
        <ng-container [ngTemplateOutlet]="activityTemplate" [ngTemplateOutletContext]="{activity: activity}"></ng-container>
    </ng-container>
</div>

<ng-template #activityTemplate>
    <ng-container *ngTemplateOutlet="headerTemplate"></ng-container>
    <ng-container *ngTemplateOutlet="contentTemplate"></ng-container>
</ng-template>

<ng-template #collapsibleActivityTemplate>
    <app-collapsible [customHeader]="true">
        <ng-container headerContent *ngTemplateOutlet="headerTemplate"></ng-container>
        <ng-container hiddenContent *ngTemplateOutlet="contentTemplate"></ng-container>
    </app-collapsible>
</ng-template>

<ng-template #headerTemplate>
    <div class="d-flex align-items-center justify-content-between mb-2 box p-2">
        <div class="d-flex align-items-center">
            <app-athlete *ngIf="activity?.athlete" [size]="'small'" [athleteId]="activity?.athlete.id"></app-athlete>
            <span class="text-small ml-1">
            {{activityVerbMap.get(activityType)}} <span class="text-bold">{{activity[validationService.baseActivityTypeMap.get(activityType)] | activityProp : validationService.baseActivityTypeMap.get(activityType)}}</span>
        </span>
        </div>
        <div *ngIf="activity.map?.summary_polyline">
            <app-svg (click)="showMap()"
                     class="pointer"
                     [icon]="'map'"
                     height="30"
                     width="30"
            ></app-svg>
        </div>
    </div>
</ng-template>

<ng-template #mapViewPopup>
    <div class="popup box">
        <app-swiper [polyline]="activity.map?.summary_polyline"
                    [activityType]="activityType"
        ></app-swiper>
    </div>
</ng-template>

<ng-template #contentTemplate>
    <div *ngFor="let card of activity.gameData?.cardSnapshots; trackBy: cardTrackBy" class="box p-2 mb-2">
        <div class="d-flex align-items-center justify-content-between"
             [ngClass]="{'mb-1': card.attachedImages?.length || activity.map?.summary_polyline}"
        >
            <div class="d-flex align-items-center">
                <app-athlete *ngIf="activity?.athlete" [size]="'small'" [athleteId]="activity?.athlete.id"></app-athlete>
                &nbsp;
                <span class="text-small">completed <span class="text-bold">"{{card.title}}"</span></span>
            </div>
            <app-image [src]="card.image" class="mr-1" [small]="true"></app-image>
        </div>
        <ng-container *ngIf="showReports">
            <p class="color-other" *ngFor="let report of card.reports | keyvalue">{{report.value}} by {{report.key}}</p>
        </ng-container>
        <app-gallery [images]="card.attachedImages"
                     [polyline]="activity.map?.summary_polyline"
                     [activityType]="activityType"
        ></app-gallery>
        <div class="d-flex justify-content-between mt-2">
            <app-button (click)="report(card.id)"
                        [small]="true"
                        [label]="(card?.reports && card?.reports[myId]) ? 'Reported' : 'Report'"
                        [icon]="'flag'"
                        [type]="(card?.reports && card?.reports[myId]) ? 'danger-filled': 'danger'"></app-button>
            <app-button (click)="(card?.likes && card?.likes?.indexOf(myId) !== -1) || like(card.id)"
                        [small]="true"
                        [label]="(card?.likes && card?.likes?.indexOf(myId) !== -1) ? card?.likes?.length : 'Like'"
                        [icon]="'fire'"
                        [type]="(card?.likes && card?.likes?.indexOf(myId) !== -1) ? 'danger-filled': 'danger'"></app-button>
        </div>
    </div>
</ng-template>